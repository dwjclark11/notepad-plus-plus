name: Release Build

on:
  push:
    tags:
      - 'v*'
      - 'linux-port-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 8.6.0)'
        required: true
        default: '8.6.0-linux-alpha'
      prerelease:
        description: 'Is this a pre-release?'
        type: boolean
        required: true
        default: true

env:
  BUILD_TYPE: Release
  QT_VERSION: 6.6

jobs:
  # ============================================================================
  # Build Release Binaries
  # ============================================================================
  build-linux-release:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [x86_64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-base-dev-tools \
            libqt6widgets6 \
            libqt6gui6 \
            libqt6network6 \
            libqscintilla2-qt6-dev \
            pkg-config

      - name: Configure CMake
        working-directory: PowerEditor/src
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: Build
        working-directory: PowerEditor/src/build
        run: ninja -j$(nproc)

      - name: Strip binary
        working-directory: PowerEditor/src/build
        run: strip notepad-plus-plus || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: notepad-plus-plus-linux-${{ matrix.arch }}
          path: PowerEditor/src/build/notepad-plus-plus
          retention-days: 30

  # ============================================================================
  # Create AppImage
  # ============================================================================
  build-appimage:
    runs-on: ubuntu-20.04  # Use older Ubuntu for better compatibility
    needs: build-linux-release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-base-dev-tools \
            libqt6widgets6 \
            libqt6gui6 \
            libqt6network6 \
            libqscintilla2-qt6-dev \
            pkg-config \
            libfuse2 \
            wget

      - name: Download linuxdeployqt
        run: |
          wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage" \
            -O linuxdeployqt
          chmod a+x linuxdeployqt

      - name: Build for AppImage
        working-directory: PowerEditor/src
        run: |
          mkdir -p build-appimage
          cd build-appimage
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INSTALL_PREFIX=/usr
          ninja -j$(nproc)

      - name: Prepare AppImage structure
        working-directory: PowerEditor/src/build-appimage
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/metainfo

          # Copy binary
          cp notepad-plus-plus AppDir/usr/bin/

          # Copy Qt plugins and libraries
          # This will be handled by linuxdeployqt

          # Create desktop entry
          cat > AppDir/usr/share/applications/notepad-plus-plus.desktop << 'EOF'
          [Desktop Entry]
          Name=Notepad++
          Comment=Text and source code editor
          Exec=notepad-plus-plus
          Icon=notepad-plus-plus
          Type=Application
          Categories=TextEditor;Development;IDE;
          Terminal=false
          StartupNotify=true
          MimeType=text/plain;text/x-csrc;text/x-c++src;
          EOF

          # Create AppRun
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export QT_PLUGIN_PATH="${HERE}/usr/plugins"
          exec "${HERE}/usr/bin/notepad-plus-plus" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Copy desktop file to root
          cp AppDir/usr/share/applications/notepad-plus-plus.desktop AppDir/

          # Create a simple icon placeholder (should be replaced with actual icon)
          # For now, we'll skip the icon requirement

      - name: Build AppImage
        working-directory: PowerEditor/src/build-appimage
        run: |
          # Use linuxdeployqt to bundle dependencies
          ./../../linuxdeployqt \
            AppDir/usr/share/applications/notepad-plus-plus.desktop \
            -appimage \
            -bundle-non-qt-libs \
            -qmake=/usr/lib/qt6/bin/qmake || true

          # If linuxdeployqt fails, create a simple tarball instead
          if [ ! -f Notepad++*.AppImage ]; then
            echo "AppImage creation failed, creating tarball instead"
            tar czf notepad-plus-plus-linux-x86_64.tar.gz -C AppDir .
          fi

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: notepad-plus-plus-appimage
          path: |
            PowerEditor/src/build-appimage/*.AppImage
            PowerEditor/src/build-appimage/*.tar.gz
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # Create Flatpak
  # ============================================================================
  build-flatpak:
    runs-on: ubuntu-latest
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-23.08
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Flatpak Builder
        run: |
          apt-get update
          apt-get install -y flatpak-builder

      - name: Create Flatpak manifest
        run: |
          mkdir -p flatpak-build
          cat > flatpak-build/com.notepad_plus_plus.NotepadPlusPlus.yml << 'EOF'
          app-id: com.notepad_plus_plus.NotepadPlusPlus
          runtime: org.freedesktop.Platform
          runtime-version: '23.08'
          sdk: org.freedesktop.Sdk
          sdk-extensions:
            - org.freedesktop.Sdk.Extension.qt6
          command: notepad-plus-plus
          finish-args:
            - --share=ipc
            - --socket=x11
            - --socket=wayland
            - --filesystem=home
            - --filesystem=host
            - --share=network
            - --device=dri
          modules:
            - name: qscintilla
              buildsystem: qmake
              sources:
                - type: archive
                  url: https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz
                  sha256: dfe13c6acc9d85dfcba76ccc8061e71a223957a6c02f3c343b30a9d43b84af27
              config-opts:
                - --qt=qt6

            - name: notepad-plus-plus
              buildsystem: cmake-ninja
              config-opts:
                - -DCMAKE_BUILD_TYPE=Release
              sources:
                - type: dir
                  path: .
          EOF

      - name: Build Flatpak
        run: |
          cd flatpak-build
          # Build the Flatpak (this may take a while)
          flatpak-builder --repo=repo --force-clean build-dir com.notepad_plus_plus.NotepadPlusPlus.yml || true

          # Create bundle if build succeeded
          if [ -d repo ]; then
            flatpak build-bundle repo notepad-plus-plus.flatpak com.notepad_plus_plus.NotepadPlusPlus || true
          fi

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: notepad-plus-plus-flatpak
          path: flatpak-build/*.flatpak
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # Create Debian Package
  # ============================================================================
  build-debian:
    runs-on: ubuntu-22.04
    needs: build-linux-release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            libqscintilla2-qt6-dev \
            pkg-config \
            debhelper \
            devscripts \
            fakeroot

      - name: Build Debian package
        working-directory: PowerEditor/src
        run: |
          mkdir -p build-deb
          cd build-deb
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INSTALL_PREFIX=/usr
          ninja -j$(nproc)

          # Create debian package structure
          mkdir -p debian-package/DEBIAN
          mkdir -p debian-package/usr/bin
          mkdir -p debian-package/usr/share/applications
          mkdir -p debian-package/usr/share/doc/notepad-plus-plus
          mkdir -p debian-package/usr/share/icons/hicolor/256x256/apps

          # Copy files
          cp notepad-plus-plus debian-package/usr/bin/
          cp ../../LICENSE debian-package/usr/share/doc/notepad-plus-plus/copyright || true

          # Create control file
          cat > debian-package/DEBIAN/control << 'EOF'
          Package: notepad-plus-plus
          Version: 8.6.0-1
          Section: editors
          Priority: optional
          Architecture: amd64
          Depends: libqt6widgets6, libqt6gui6, libqt6core6, libqscintilla2-qt6-15
          Maintainer: Notepad++ Team <team@notepad-plus-plus.org>
          Description: Text and source code editor
           Notepad++ is a free source code editor and Notepad replacement
           that supports several programming languages running under the
           MS Windows environment, now ported to Linux.
          EOF

          # Create desktop entry
          cat > debian-package/usr/share/applications/notepad-plus-plus.desktop << 'EOF'
          [Desktop Entry]
          Name=Notepad++
          Comment=Text and source code editor
          Exec=/usr/bin/notepad-plus-plus
          Icon=notepad-plus-plus
          Type=Application
          Categories=TextEditor;Development;IDE;
          Terminal=false
          StartupNotify=true
          MimeType=text/plain;text/x-csrc;text/x-c++src;
          EOF

          # Build package
          dpkg-deb --build debian-package notepad-plus-plus_8.6.0-1_amd64.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: notepad-plus-plus-debian
          path: PowerEditor/src/build-deb/*.deb
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # Create RPM Package
  # ============================================================================
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    needs: build-linux-release

    steps:
      - name: Install dependencies
        run: |
          dnf update -y
          dnf install -y \
            git \
            cmake \
            ninja-build \
            gcc \
            gcc-c++ \
            qt6-qtbase-devel \
            qt6-qscintilla-qt6-devel \
            pkgconfig \
            rpm-build \
            rpmdevtools

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree

      - name: Build RPM package
        working-directory: PowerEditor/src
        run: |
          mkdir -p build-rpm
          cd build-rpm
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_INSTALL_PREFIX=/usr
          ninja -j$(nproc)

          # Create RPM spec file
          mkdir -p ~/rpmbuild/SOURCES
          mkdir -p ~/rpmbuild/SPECS

          cat > ~/rpmbuild/SPECS/notepad-plus-plus.spec << 'EOF'
          Name:           notepad-plus-plus
          Version:        8.6.0
          Release:        1%{?dist}
          Summary:        Text and source code editor
          License:        GPL-2.0+
          URL:            https://notepad-plus-plus.org/
          BuildArch:      x86_64

          Requires:       qt6-qtbase-gui, qt6-qscintilla-qt6

          %description
          Notepad++ is a free source code editor and Notepad replacement
          that supports several programming languages.

          %install
          mkdir -p %{buildroot}/usr/bin
          cp %{_sourcedir}/notepad-plus-plus %{buildroot}/usr/bin/

          %files
          /usr/bin/notepad-plus-plus

          %changelog
          * Mon Jan 01 2024 Notepad++ Team <team@notepad-plus-plus.org> - 8.6.0-1
          - Initial Linux port release
          EOF

          # Copy binary to sources
          cp notepad-plus-plus ~/rpmbuild/SOURCES/

          # Build RPM (may fail due to missing dependencies, that's OK for now)
          rpmbuild -ba ~/rpmbuild/SPECS/notepad-plus-plus.spec || true

      - name: Upload RPM
        uses: actions/upload-artifact@v4
        with:
          name: notepad-plus-plus-rpm
          path: /github/home/rpmbuild/RPMS/**/*.rpm
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  create-release:
    runs-on: ubuntu-latest
    needs: [build-linux-release, build-appimage, build-flatpak, build-debian, build-rpm]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Artifacts to be released:"
          find artifacts -type f -ls

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Notepad++ Linux Port ${{ github.ref_name }}
          body: |
            ## Notepad++ Linux Port ${{ github.ref_name }}

            This is a Linux port of Notepad++ using Qt6.

            ### Available Packages

            - **Binary**: Standalone executable
            - **AppImage**: Universal Linux package
            - **Flatpak**: For Flatpak-enabled distributions
            - **Debian Package**: For Debian/Ubuntu-based distributions
            - **RPM Package**: For Fedora/RHEL-based distributions

            ### Installation

            #### Debian/Ubuntu
            ```bash
            sudo dpkg -i notepad-plus-plus_*.deb
            sudo apt-get install -f  # Fix any dependency issues
            ```

            #### Fedora/RHEL
            ```bash
            sudo rpm -i notepad-plus-plus-*.rpm
            ```

            #### AppImage
            ```bash
            chmod +x Notepad++*.AppImage
            ./Notepad++*.AppImage
            ```

            #### Flatpak
            ```bash
            flatpak install notepad-plus-plus.flatpak
            ```

            ### Known Issues

            - This is an early port and may have bugs
            - Some Windows-specific features may not work
            - Plugin compatibility is limited

            ### Building from Source

            See BUILD.md for build instructions.
          files: |
            artifacts/**/*
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') || inputs.prerelease == true }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
