name: Code Quality

on:
  push:
    branches: [master, main, linux-port]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [master, main, linux-port]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

env:
  QT_VERSION: 6.6

jobs:
  # ============================================================================
  # clang-format Check
  # ============================================================================
  clang-format:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
          sudo update-alternatives --install /usr/bin/clang-format clang-format /usr/bin/clang-format-18 100

      - name: Create .clang-format if not exists
        run: |
          if [ ! -f .clang-format ]; then
            echo "Language: Cpp" > .clang-format
            echo "BasedOnStyle: LLVM" >> .clang-format
            echo "IndentWidth: 4" >> .clang-format
            echo "TabWidth: 4" >> .clang-format
            echo "UseTab: Always" >> .clang-format
            echo "ColumnLimit: 120" >> .clang-format
            echo "AllowShortFunctionsOnASingleLine: Empty" >> .clang-format
            echo "AllowShortIfStatementsOnASingleLine: Never" >> .clang-format
            echo "AllowShortLoopsOnASingleLine: false" >> .clang-format
            echo "BreakBeforeBraces: Allman" >> .clang-format
            echo "PointerAlignment: Left" >> .clang-format
            echo "ReferenceAlignment: Left" >> .clang-format
            echo "SortIncludes: true" >> .clang-format
            echo "IncludeBlocks: Preserve" >> .clang-format
            echo "SpaceAfterCStyleCast: false" >> .clang-format
            echo "SpaceAfterLogicalNot: false" >> .clang-format
            echo "SpaceAfterTemplateKeyword: false" >> .clang-format
            echo "SpaceBeforeAssignmentOperators: true" >> .clang-format
            echo "SpaceBeforeCpp11BracedList: false" >> .clang-format
            echo "SpaceBeforeCtorInitializerColon: true" >> .clang-format
            echo "SpaceBeforeInheritanceColon: true" >> .clang-format
            echo "SpaceBeforeParens: ControlStatements" >> .clang-format
            echo "SpaceBeforeRangeBasedForLoopColon: true" >> .clang-format
            echo "SpaceInEmptyParentheses: false" >> .clang-format
            echo "SpacesBeforeTrailingComments: 1" >> .clang-format
            echo "SpacesInAngles: false" >> .clang-format
            echo "SpacesInCStyleCastParentheses: false" >> .clang-format
            echo "SpacesInContainerLiterals: false" >> .clang-format
            echo "SpacesInParentheses: false" >> .clang-format
            echo "SpacesInSquareBrackets: false" >> .clang-format
            echo "Standard: c++20" >> .clang-format
          fi

      - name: Run clang-format check
        run: |
          # Find all C++ files
          FILES=$(find PowerEditor/src -type f \( -name "*.cpp" -o -name "*.h" -o -name "*.hpp" \) \
            ! -path "*/TinyXml/*" \
            ! -path "*/pugixml/*" \
            ! -path "*/uchardet/*" \
            ! -path "*/json/*" \
            ! -path "*/lexilla/*" \
            ! -path "*/scintilla/*" \
            ! -path "*/boostregex/*" \
            2>/dev/null)

          if [ -z "$FILES" ]; then
            echo "No files to check"
            exit 0
          fi

          # Check formatting
          echo "$FILES" | xargs clang-format --dry-run --Werror 2>&1 | tee clang-format-output.txt || true

          # Count issues
          if [ -s clang-format-output.txt ]; then
            ISSUES=$(grep -c "error:" clang-format-output.txt || echo "0")
            echo "Found $ISSUES formatting issues"
            if [ "$ISSUES" -gt 0 ]; then
              echo "::warning::Found $ISSUES clang-format issues"
              # Don't fail the build, just warn
            fi
          else
            echo "All files are properly formatted!"
          fi

      - name: Upload clang-format report
        uses: actions/upload-artifact@v4
        with:
          name: clang-format-report
          path: clang-format-output.txt
          retention-days: 7

  # ============================================================================
  # clang-tidy Analysis
  # ============================================================================
  clang-tidy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qt6-base-dev-tools \
            qscintilla2-qt6-dev \
            pkg-config \
            clang-tidy-18 \
            clang-tools-18

      - name: Create .clang-tidy if not exists
        run: |
          if [ ! -f .clang-tidy ]; then
            echo "Checks: > bugprone-*,cppcoreguidelines-*,modernize-*,performance-*,portability-*,readability-*" > .clang-tidy
            echo "HeaderFilterRegex: PowerEditor/src/.*" >> .clang-tidy
            echo "FormatStyle: file" >> .clang-tidy
          fi

      - name: Configure CMake for compile_commands.json
        working-directory: PowerEditor/src
        run: |
          mkdir -p build
          cd build
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_CXX_STANDARD=20

      - name: Run clang-tidy
        working-directory: PowerEditor/src
        run: |
          # Find all C++ files (excluding third-party)
          FILES=$(find . -type f \( -name "*.cpp" \) \
            ! -path "*/TinyXml/*" \
            ! -path "*/pugixml/*" \
            ! -path "*/uchardet/*" \
            ! -path "*/json/*" \
            ! -path "*/lexilla/*" \
            ! -path "*/scintilla/*" \
            ! -path "*/boostregex/*" \
            ! -path "*/build/*" \
            ! -path "*/_build/*" \
            2>/dev/null | head -50)

          if [ -z "$FILES" ]; then
            echo "No files to analyze"
            exit 0
          fi

          # Run clang-tidy with limited checks to avoid noise
          echo "$FILES" | xargs clang-tidy-18 \
            -p build \
            --checks="-*,bugprone-*,performance-*,portability-*,modernize-use-nullptr,modernize-use-override,cppcoreguidelines-special-member-functions" \
            2>&1 | tee clang-tidy-report.txt || true

          echo "clang-tidy analysis complete"

      - name: Upload clang-tidy report
        uses: actions/upload-artifact@v4
        with:
          name: clang-tidy-report
          path: PowerEditor/src/clang-tidy-report.txt
          retention-days: 7

  # ============================================================================
  # cppcheck Static Analysis
  # ============================================================================
  cppcheck:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        working-directory: PowerEditor/src
        run: |
          cppcheck \
            --enable=all \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --suppress=toomanyconfigs \
            --suppress=shadowFunction \
            --suppress=shadowVariable \
            --suppress=shadowArgument \
            --error-exitcode=0 \
            --std=c++20 \
            --xml \
            --xml-version=2 \
            -I. \
            -I../../scintilla/include \
            -I../../lexilla/include \
            -iTinyXml \
            -ipugixml \
            -iuchardet \
            -ijson \
            -ibuild \
            -i_build \
            . 2> cppcheck-report.xml || true

          # Also generate text report
          cppcheck \
            --enable=all \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression \
            --suppress=toomanyconfigs \
            --suppress=shadowFunction \
            --suppress=shadowVariable \
            --suppress=shadowArgument \
            --error-exitcode=0 \
            --std=c++20 \
            -I. \
            -I../../scintilla/include \
            -I../../lexilla/include \
            -iTinyXml \
            -ipugixml \
            -iuchardet \
            -ijson \
            -ibuild \
            -i_build \
            . 2> cppcheck-report.txt || true

          echo "cppcheck analysis complete"

      - name: Upload cppcheck report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            PowerEditor/src/cppcheck-report.xml
            PowerEditor/src/cppcheck-report.txt
          retention-days: 7

      - name: cppcheck summary
        run: |
          if [ -f PowerEditor/src/cppcheck-report.txt ]; then
            echo "=== cppcheck Summary ==="
            grep -E "^(error|warning|style|performance|portability|information):" PowerEditor/src/cppcheck-report.txt | wc -l
            echo "Total issues found (see artifact for details)"
          fi

  # ============================================================================
  # Code Coverage Summary
  # ============================================================================
  coverage-summary:
    runs-on: ubuntu-24.04
    needs: []
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            qt6-base-dev \
            qscintilla2-qt6-dev \
            gcovr

      - name: Build with coverage
        working-directory: PowerEditor/src
        run: |
          mkdir -p build-coverage
          cd build-coverage
          cmake .. \
            -GNinja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage" \
            -DCMAKE_C_FLAGS="--coverage"
          ninja -j$(nproc)

      - name: Generate coverage summary
        working-directory: PowerEditor/src/build-coverage
        run: |
          gcovr -r .. --txt --txt-summary 2>&1 | tee coverage-summary.txt || true

      - name: Comment coverage on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const coverageFile = 'PowerEditor/src/build-coverage/coverage-summary.txt';
            let coverage = 'Coverage report not available';
            try {
              coverage = fs.readFileSync(coverageFile, 'utf8');
            } catch (e) {
              coverage = 'Failed to generate coverage report';
            }

            const body = `## Code Coverage Summary

            \`\`\`
            ${coverage}
            \`\`\`

            *Note: This is a preliminary coverage report. See artifacts for detailed HTML report.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # Quality Gate
  # ============================================================================
  quality-gate:
    runs-on: ubuntu-24.04
    needs: [clang-format, clang-tidy, cppcheck]
    if: always()

    steps:
      - name: Check quality results
        run: |
          echo "=== Code Quality Summary ==="
          echo "clang-format: ${{ needs.clang-format.result }}"
          echo "clang-tidy: ${{ needs.clang-tidy.result }}"
          echo "cppcheck: ${{ needs.cppcheck.result }}"

          # Only fail on critical errors, allow warnings
          if [ "${{ needs.clang-format.result }}" == "failure" ] || \
             [ "${{ needs.clang-tidy.result }}" == "failure" ] || \
             [ "${{ needs.cppcheck.result }}" == "failure" ]; then
            echo "::warning::Some code quality checks failed - see artifacts for details"
            # Don't fail the build for now, just warn
            exit 0
          fi

          echo "All code quality checks passed!"
